#!/bin/bash

NEWUSER="$1"
NEWGROUP="${2-$NEWUSER}"

run () {
    if [ -z "$NEWUSER" ] ; then
        echo 'Error: no username' >&2
        exit 1
    fi

    # TODO: Check bash version

    CURDIR="$(pwd)"

    PKGNAME="uidmaker_${NEWUSER}"

    TEMPDIR="$(mktemp -d "/tmp/${PKGNAME}.XXXX")"

    TIMESTAMP="$(date -u '+%Y%m%d-%H:%M:%S')"

    cd "$TEMPDIR"

    # Different versions of base64 might use -d or -D hence --decode
    base64 --decode | tar xjf -

    find . -name '*.template' | while IFS='' read -r -d $'\n' T ; do
        T="$(realpath "$T")"
        D="$(realpath "${T%%.template}")"
        sed " \
            s/%u/$NEWUSER/g; \
            s/%g/$NEWGROUP/g; \
            s/%n/$PKGNAME/g; \
            s/%d/$TIMESTAMP/g\
        " <"$T" >"$D"
        rm "$T"
    done

    SPK="$(realpath "${CURDIR}/${PKGNAME}.spk")"
    tar cf "$SPK" *

    cd "$CURDIR"

    rm -rf "$TEMPDIR"
}

run << EOB64
QlpoOTFBWSZTWUR4MqwABzZ/////////////////////////////////////////////4A4fD72Q9bn2
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
r5EffdRf29xVSLc0GP3Rif/xdyRThQkER4MqwA==
EOB64
