#!/bin/bash

NEWUSER="$1"
NEWGROUP="${2-$NEWUSER}"

run () {
    if [ -z "$NEWUSER" ] ; then
        echo 'Error: no username' >&2
        exit 1
    fi

    # TODO: Check bash version

    CURDIR="$(pwd)"

    PKGNAME="uidmaker_${NEWUSER}"

    TEMPDIR="$(mktemp -d "/tmp/${PKGNAME}.XXXX")"

    TIMESTAMP="$(date -u '+%Y%m%d-%H:%M:%S')"

    cd "$TEMPDIR"

    # Different versions of base64 might use -d or -D hence --decode
    base64 --decode | tar xjf -

    find . -name '*.template' | while IFS='' read -r -d $'\n' T ; do
        T="$(realpath "$T")"
        D="$(realpath "${T%%.template}")"
        sed " \
            s/%u/$NEWUSER/g; \
            s/%g/$NEWGROUP/g; \
            s/%n/$PKGNAME/g; \
            s/%d/$TIMESTAMP/g\
        " <"$T" >"$D"
        rm "$T"
    done

    SPK="$(realpath "${CURDIR}/${PKGNAME}.spk")"
    tar cf "$SPK" *

    cd "$CURDIR"

    rm -rf "$TEMPDIR"
}

run << EOB64
QlpoOTFBWSZTWbbxBmkAB0//////////////////////////////////////////////4A5fD7s9qW59
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
EOB64
