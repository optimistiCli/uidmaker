#!/bin/bash

NEWUSER="$1"

run () {
    if [ -z "$NEWUSER" ] ; then
        echo 'Error: no username' >&2
        exit 1
    fi

    # TODO: Check bash version

    # TODO: Check if username is valid

    # TODO: Check base64 for -d or -D option

    CURDIR="$(pwd)"

    PKGNAME="uidmaker_${NEWUSER}"

    TEMPDIR="$(mktemp -d "/tmp/${PKGNAME}.XXXX")"

    TIMESTAMP="$(date -u '+%Y%m%d-%H:%M:%S')"

    cd "$TEMPDIR"

    base64 -d | tar xjf -

    find . -name '*.template' | while IFS='' read -d $'\n' T ; do
        T="$(realpath "$T")"
        D="$(realpath "${T%%.template}")"
        sed "s/%s/$NEWUSER/g" < "$T" \
            | sed "s/%n/$PKGNAME/g" \
            | sed "s/%d/$TIMESTAMP/g" > "$D"
        rm "$T"
    done

    SPK="$(realpath "${CURDIR}/${PKGNAME}.spk")"
    tar cf "$SPK" *

    cd "$CURDIR"

    rm -rf "$TEMPDIR"
}

run << EOB64
QlpoOTFBWSZTWRR873MABPF/////////////////////////////////////////////4A0fD5e9
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
kBR873M=
EOB64
